<?php

/**
 * @file
 * Tests for PROJECTFEATURE_feature_set.module.
 * ECWeb MULTISITE QA
 */

/**
 * Defines a base class for testing the "Feature Set" module.
 */
class MultisiteFeatureSetFeatureTest extends DrupalWebTestCase {

  /**
   * GetInfo.
   */
  public static function getInfo() {
    return array(
      'name' => 'feature_set Feature test',
      'description' => t('Test the Feature Set feature to ensure it works as intended.'),
      'group' => 'Multisite Feature Test',
    );
  }

  /**
   * Configure environment: declare modules, users, permissions...
   */
  public function setUp() {
    // Enable any modules required for the test.
    parent::setUp(array('feature_set', 'multisite_drupal_features_set_standard'));

  }

  /**
   * Verify that current user has no access to page.
   *
   * @param string $url
   *   URL to verify.
   */
  public function multisiteFeatureSetTestVerifyNoAccess($url) {
    // Test that page returns 403 Access Denied.
    $this->drupalGet($url);
    $this->assertResponse(403, t('Expected -> Access Denied'));
  }

  /**
   * Verify that current user has access to Site information page.
   *
   * @param string $url
   *   URL to verify.
   */
  public function multisiteFeatureSetVerifyAccess($url) {
    // Test that page returns 200 Access OK.
    $this->drupalGet($url);
    $this->assertResponse(200, t('Expected -> Access OK'));
    $this->assertText(t('Feature Set'), t('Feature Set form is loaded.'));
  }

  /**
   * Check that user can access to the feature form settings.
   */
  public function testMultisiteFeatureSetAccess() {
    // Try to access with a non authenticated user.
    $this->multisiteFeatureSetTestVerifyNoAccess('admin/structure/feature-set');
    // Create user without permissions to access.
    $this->web_user = $this->drupalCreateUser();
    $this->drupalLogin($this->web_user);
    $this->multisiteFeatureSetTestVerifyNoAccess('admin/structure/feature-set');
    // Create usr with permissions to access to the content-type administration.
    $this->web_user = $this->drupalCreateUser(array('administer feature sets'));
    $this->drupalLogin($this->web_user);
    // Verify that users with permission can access to the Feature Set page.
    $this->multisiteFeatureSetVerifyAccess('admin/structure/feature-set');
  }

  /**
   * Configure Feature Set feature and test that it works as intends.
   */
  public function testMultisiteFeatureSetEnableFeatures() {
    // Create a user to access and to create articles.
    $this->web_user = $this->drupalCreateUser(array('administer feature sets', 'administer modules'));
    $this->drupalLogin($this->web_user);

    $this->drupalGet('admin/structure/feature-set');
    $this->assertText(t('EC Content slider'), t('Feature "EC Content slider" appears.'));
    $this->assertNoFieldChecked('edit-featureset-ec-content-slider', t('Feature "EC Content slider" is disabled.'));
    $this->assertText(t('Multisite Meta tags'), t('Feature "Multisite Meta tags" appears.'));
    $this->assertNoFieldChecked('edit-featureset-multisite-metatags', t('Feature "Multisite Meta tags" is disabled.'));

    $edit = array();
    $edit['featureset-ec_content_slider'] = TRUE;
    $edit['featureset-multisite_metatags'] = TRUE;
    $this->drupalPost('admin/structure/feature-set', $edit, t('Validate'));

    $this->drupalGet('admin/structure/feature-set');
    $this->assertFieldChecked('edit-featureset-ec-content-slider', t('Feature "EC Content slider" is enabled.'));
    $this->assertFieldChecked('edit-featureset-multisite-metatags', t('Feature "Multisite Meta tags" is enabled.'));

    $this->drupalGet('admin/modules');
    $this->assertFieldChecked('edit-modules-multisite-features-ec-content-slider-enable', t('Module "Content-slider" is enabled in admin/modules.'));
    $this->assertFieldChecked('edit-modules-multisite-features-multisite-metatags-enable', t('Module "Multisite Megatags" is enabled in admin/modules.'));

    $this->drupalGet('admin/structure/feature-set');
    $edit = array();
    $edit['featureset-ec_content_slider'] = FALSE;
    $edit['featureset-multisite_metatags'] = FALSE;
    $this->drupalPost('admin/structure/feature-set', $edit, t('Validate'));

    $this->drupalGet('admin/structure/feature-set');
    $this->assertNoFieldChecked('edit-featureset-ec-content-slider', t('Feature "EC Content slider" is disabled.'));
    $this->assertNoFieldChecked('edit-featureset-multisite-metatags', t('Feature "Multisite Meta tags" is disabled.'));

    $this->drupalGet('admin/modules');
    $this->assertNoFieldChecked('edit-modules-multisite-features-ec-content-slider-enable', t('Module "Content-slider" is disabled in admin/modules.'));
    $this->assertNoFieldChecked('edit-modules-multisite-features-multisite-metatags-enable', t('Module "Multisite Megatags" is disabled in admin/modules.'));
  }
}
