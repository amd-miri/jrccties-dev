<?php

/**
 * @file media_cck.module
 *
 */

define('MEDIA_CCK_WEBSERVICE_URL', 'http://ec.europa.eu/cookie-consent/iframe');

/**
 * Implements hook_form_FORM_ID_alter().
 */
function media_cck_form_multisite_cookie_consent_admin_settings_alter(&$form, &$form_state) {
  $form['eucookie_consent_media'] = array(
    '#type' => 'fieldset',
    '#title' => t('Cookie Consent Kit: Media settings'),
  );

  $form['eucookie_consent_media']['eucookie_consent_webservice_url'] = array(
    '#type' => 'textfield',
    '#title' => t('URL of the Cookie Consent WebService'),
    '#default_value' => variable_get('eucookie_consent_webservice_url', MEDIA_CCK_WEBSERVICE_URL),
    '#maxlength' => NULL,
    '#description' => t('See !url for more info', array('!url' => l('Preventing references to external sources from setting cookies', 'http://webtools.ec.europa.eu/cookie-consent/documentation/index.php?page=external-sources.html', array('attributes' => array('target' => '_blank'))))),
    '#required' => TRUE,
  );

  $form['#validate'][] = '_media_cck_form_multisite_cookie_consent_admin_settings_validate';
}

/**
 * Validate multisite_cookie_consent form.
 */
function _media_cck_form_multisite_cookie_consent_admin_settings_validate(&$form, &$form_state) {
  // Ensure URL is valid.
  if (!valid_url($form_state['values']['eucookie_consent_webservice_url'], TRUE)) {
    form_set_error('eucookie_consent_media][eucookie_consent_webservice_url', t('The URL %url is invalid. Enter a fully-qualified URL, such as http://www.example.com/cookie-consent.', array('%url' => $form_state['values']['eucookie_consent_webservice_url'])));
  }
}

/**
 * Implements hook_theme_registry_alter().
 */
function media_cck_theme_registry_alter(&$theme_registry) {
  $path = drupal_get_path('module', 'media_cck') . '/themes';

  foreach (array('media_youtube', 'media_vimeo', 'media_dailymotion') as $module) {
    if (module_exists($module)) {
      // Override the location of several Media Internet providers template files.
      $theme_registry[$module . '_video']['path'] = $path;

      // Add our preprocess function to the bottom
      $theme_registry[$module . '_video']['preprocess functions'][] = '_media_cck_preprocess_' . $module . '_video';
    }
  }
}

/**
 * Preprocess function for media_youtube_video.
 */
function _media_cck_preprocess_media_youtube_video(&$variables) {
  _media_cck_preprocess_media_cck_video($variables);
}

/**
 * Preprocess function for media_vimeo_video.
 */
function _media_cck_preprocess_media_vimeo_video(&$variables) {
  _media_cck_preprocess_media_cck_video($variables);
}

/**
 * Preprocess function for media_dailymotion_video.
 */
function _media_cck_preprocess_media_dailymotion_video(&$variables) {
  // We support only iframe (not object) for dailymotion. See media_dailymotion.theme.inc
  $daily_query = array('logo' => 0, 'autoPlay' => $variables['autoplay']);
  $variables['url'] = url('http://www.dailymotion.com/embed/video/' . $variables['video_id'], array('query' => $daily_query, 'external' => TRUE));

  _media_cck_preprocess_media_cck_video($variables);
}

/**
 * Custom function to alter media_[module]_video template variables.
 */
function _media_cck_preprocess_media_cck_video(&$variables) {
  global $language;

  // Build the final url
  $media_cck_webservice_url = variable_get('eucookie_consent_webservice_url', MEDIA_CCK_WEBSERVICE_URL);
  $query = array();
  $query['oriurl'] = $variables['url'];
  $query['lang']= $language->language;

  // Allow other modules to alter query parameters
  drupal_alter('media_cck_query', $query);

  $variables['media_cck_url'] = url($media_cck_webservice_url, array('query' => $query, 'external' => TRUE));
}