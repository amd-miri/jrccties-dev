<?php
/*
 * get User info from the comref database
 */
function getComRefUserInfo($perid, $fields = array('no_sysper'), $info = null) { 
  $config = variable_get('oracle_access');  
  $data = "op=getComRefUserInfo&per_id=".$perid."&access_token=".$config['access_token']."&info=".$info."&fields=".implode(",", $fields);

  $options = array(
    'method' => 'POST',
    'data' => $data,
    'headers' => array(
      'Content-Type' => 'application/x-www-form-urlencoded',  
    ),
  );

  $result = drupal_http_request($config['url'], $options);

  if($result->code == '200') {
    $xmlobj = simplexml_load_string($result->data);
    $values = json_decode(json_encode((array)$xmlobj), TRUE);

    //print_r($result->data);
    //exit();

  }
  else {
    watchdog('oracle access', 'connection issue with the oracle service'); 
  }

  return isset($values)?$values['records']:null;
  //return isset($xmlobj)?$xmlobj:null;
}



/*
 * get info from the comref database
 */
function getComRefInfo($info, $fields = array()) {
  $config = variable_get('oracle_access');
  $data = "op=getComRefInfo&access_token=".$config['access_token']."&info=".$info."&fields=".implode(",", $fields);

  $options = array(
    'method' => 'POST',
    'data' => $data,
    'headers' => array(
      'Content-Type' => 'application/x-www-form-urlencoded',
    ),
  );

  $result = drupal_http_request($config['url'], $options);

  if($result->code == '200') {
    //print_r($result->data);
    //exit();

    $xmlobj = simplexml_load_string($result->data);

    //$values = xml2array($xmlobj);


    $values = json_decode(json_encode((array)$xmlobj), TRUE);
    //foreach ($xmlobj as $element) {
    //print_r($element);
    //print "--\n";
    //print $element[0];
    //  $values[] = $element[0]->__toString();

    //}

    //header('Content-Type: application/xml');
    //print $result->data;
    //exit();

  
  }
  else {
    watchdog('oracle access', 'connection issue with the oracle service');
  }

  return isset($values)?$values['records']:null;
  //return isset($xmlobj)?$xmlobj:null;
}





/*
 * replace comRef token in forms (ex : %comref['no_sysper'])
 * callback function called by a preg_replace_callback function
 */
function replace_ComRef_token($matches) {
  global $user;
  if (function_exists('getLdapUserInfo') && isset($user->name)) {
    $user_info = getLdapUserInfo($user->name, array('employeenumber'));
    $data = getComRefUserInfo($user_info['employeenumber'], array($matches['1']));
    return $data[$matches['1']];
  }
  else {
    return;  
  }
}


