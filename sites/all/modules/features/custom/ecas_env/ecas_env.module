<?php
/**
 * @file
 * Code for the ecas_env feature.
 */

include_once 'ecas_env.features.inc';

/**
* Implementation of hook_menu_link_alter
* Add CSS class to ECAS links on menu user 
*/
function ecas_env_menu_link_alter(&$item) {
  $ecas_menu_items = array ();
  $ecas_menu_items = _ecas_menu ($ecas_menu_items);
  if (isset ($ecas_menu_items[$item['link_path']]) && $item['menu_name'] == 'user-menu'){ // ECAS link on user menu ?
    // if user edit menu item, we don't force the CSS class (but currents are kept)
	if (!isset ($item['customized']) ||
       (isset ($item['customized']) && $item['customized'] == 0 )){ 
      $user_classes = 'btn btn-default btn-xs';
      $item['options']['attributes']['class'] = $user_classes;
	  
      switch ($item['link_path']){
        case 'ecas':
          $item['options']['attributes']['data-image'] = 'log-in';
        break;
        case 'ecaslogout':
          $item['options']['attributes']['data-image'] = 'log-out';
        break;
        case 'account_request':
          $item['options']['attributes']['data-image'] = 'plus';
        break;
        default;
      }
    }
  }
}

/**
* Implementation of hook_menu_alter
*/ 
function ecas_env_menu_alter(&$items) {
  $items['ecas']['menu_name'] = "user-menu";
  $items['ecaslogout']['menu_name'] = "user-menu";
  $items['account_request']['menu_name'] = "user-menu";
  $items['ecas']['type'] = MENU_NORMAL_ITEM;
  $items['ecaslogout']['type'] = MENU_NORMAL_ITEM;
  $items['account_request']['type'] = MENU_NORMAL_ITEM;
  $items['account_request']['weight'] = 99;
  
  $items['user/logout']['access callback'] = 'normal_menu_logout_check';
  $items['user/login']['access callback'] = 'normal_menu_check';
}

function normal_menu_logout_check() {
  global $user;
  $access_ecas = (isset($_SESSION['phpCAS']) && $_SESSION['phpCAS']['user'] === $user->name);
  $access = (user_is_logged_in() && !$access_ecas);
  return $access;
}

function normal_menu_check() {
  $access = (user_is_anonymous() && !module_exists("ecas"));
  return $access;
}

function ecas_env_node_view_alter(&$build) {
  if (isset($build['links']['comment']['#links']['comment_forbidden'])) {
    //alter login links in the comment area to redirect to ecas
    $account_request_url = variable_get('ecas_account_request_url', ECAS_DEFAULT_ACCOUNT_REQUEST_URL);
    $return_url = url('ecas', array('absolute' => TRUE));
    $account_request_url = str_replace('%local_ecas_url%', $return_url, $account_request_url);
    $build['links']['comment']['#links']['comment_forbidden']['title'] = '<a href="' . $return_url . '">Log in</a> or <a href="' . $account_request_url . '">register</a> to post comments';
  }
}

function ecas_env_admin_menu_output_alter(&$content) {
  global $user;
  // alter the logout link of the admin_menu when the user is connected with ecas
  if (isset($_SESSION['phpCAS']) && $_SESSION['phpCAS']['user'] === $user->name) {
    $content['account']['logout']['#title'] = t('Ecas logout');
    $content['account']['logout']['#href'] = 'ecaslogout';
  }
}
