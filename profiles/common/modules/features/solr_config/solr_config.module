<?php
/**
 * @file
 * Code for the solr_config feature.
 */

include_once 'solr_config.features.inc';

function solr_config_apachesolr_exclude($entity_id, $entity_type, $row, $env_id) {
  if ($entity_type == 'file') {
    $node = node_load($row->parent_entity_id);

    if (isset($node->workbench_moderation)) { // node moderate with workbench moderation
      $workflow = $node->workbench_moderation;
      if (isset($workflow['published'])) { // node parent is published
        return FALSE;
      }
      else {
        apachesolr_index_delete_entity_from_index($env_id, $entity_type, $entity_id . "-node-" . $node->nid); // remove file from solr index
        drupal_set_message(t('Entity @type @id removed from solr index', array('@type' => $entity_type, '@id' => $entity_id)));
        return TRUE;
      }
    }
    elseif ($node->status == 1) { // standard drupal workflow : node parent is published
      return FALSE;
    }
    else {
      apachesolr_index_delete_entity_from_index($env_id, $entity_type, $entity_id . "-node-" . $node->nid); // remove file from solr index
      drupal_set_message(t('Entity @type @id removed from solr index', array('@type' => $entity_type, '@id' => $entity_id)));
      return TRUE;
    }
  }
  return FALSE;

}


function solr_config_apachesolr_query_alter($query) {
  global $language;
  $query->addFilter('ss_language', "(und OR ".$language->language.")"); // by default set the facet language to current language and neutral language
}

function solr_config_form_alter(&$form, &$form_state, $form_id) {
  global $user;
  if($form_id == 'apachesolr_index_action_form') {
    if($user->uid != 1) {
      // show the solr index actions only for the user 1, prevent webmasters to reindex the multisite index
      unset($form['action']);
    }
  }
}

